/**
 * ùó¶ùóòùó° Bot - Group Management Commands
 * Copyright (c) 2024 ùôéùôèùôÄùôãùôÉùòøùôÄùôë
 * Commandes avec r√©actions uniquement (pas de texte)
 */

import { isAdmin, isOwner } from '../lib/authHelper.js';
import configs from '../configs.js';
import chalk from 'chalk';

// √âmojis de r√©action
const SUCCESS = '‚úÖ';
const ERROR = '‚ùå';

/**
 * Helper pour r√©agir au message
 */
async function react(sock, message, emoji) {
    try {
        await sock.sendMessage(message.key.remoteJid, {
            react: {
                text: emoji,
                key: message.key
            }
        });
        console.log(chalk.green(`‚úÖ Reacted with ${emoji}`));
    } catch (error) {
        console.error(chalk.red('Error reacting:'), error.message);
    }
}

/**
 * Helper pour v√©rifier les permissions
 */
async function checkPermissions(sock, chatId, message) {
    console.log(chalk.cyan('üîç Checking permissions...'));
    
    if (!chatId.endsWith('@g.us')) {
        console.log(chalk.yellow('‚ö†Ô∏è Not a group'));
        await react(sock, message, ERROR);
        return false;
    }
    
    const sender = message.key.participant || message.key.remoteJid;
    const admin = await isAdmin(sock, chatId, sender);
    const owner = await isOwner(sock, message, configs);
    
    console.log(chalk.cyan(`User admin: ${admin}, User owner: ${owner}`));
    
    if (!admin && !owner) {
        console.log(chalk.yellow('‚ö†Ô∏è User not admin'));
        await react(sock, message, ERROR);
        return false;
    }
    
  
    
    console.log(chalk.green('‚úÖ Permissions OK'));
    return true;
}

/**
 * Helper pour obtenir le JID d'un utilisateur (mention ou reply)
 */
function getTargetJid(message) {
    console.log(chalk.cyan('üîç Getting target JID...'));
    
    // Cas 1: Reply
    if (message.message?.extendedTextMessage?.contextInfo?.quotedMessage) {
        const jid = message.message.extendedTextMessage.contextInfo.participant;
        console.log(chalk.green(`‚úÖ Target from reply: ${jid}`));
        return jid;
    }
    
    // Cas 2: Mention
    if (message.message?.extendedTextMessage?.contextInfo?.mentionedJid?.length > 0) {
        const jid = message.message.extendedTextMessage.contextInfo.mentionedJid[0];
        console.log(chalk.green(`‚úÖ Target from mention: ${jid}`));
        return jid;
    }
    
    console.log(chalk.yellow('‚ö†Ô∏è No target found'));
    return null;
}

/**
 * Commande .add - Ajouter un membre au groupe
 * Usage: .add +237694530506 ou .add 237694530506
 */
export async function add(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .add command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    if (args.length === 0) {
        console.log(chalk.yellow('‚ö†Ô∏è No number provided'));
        return await react(sock, message, ERROR);
    }
    
    try {
        // Nettoyer le num√©ro - accepte +237xxx, 237xxx ou juste le num√©ro
        let number = args[0].replace(/[^0-9]/g, '');
        
        console.log(chalk.cyan(`üì± Cleaned number: ${number}`));
        
        const jid = number + '@s.whatsapp.net';
        
        console.log(chalk.cyan(`üë§ Adding JID: ${jid}`));
        
        const result = await sock.groupParticipantsUpdate(chatId, [jid], 'add');
        console.log(chalk.green('‚úÖ Add result:'), result);
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error adding member:'), error.message);
        await react(sock, message, ERROR);
    }
}

/**
 * Commande .kick - Expulser un membre
 * Usage: .kick @user ou reply
 */
export async function kick(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .kick command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    const targetJid = getTargetJid(message);
    
    if (!targetJid) {
        console.log(chalk.yellow('‚ö†Ô∏è No target for kick'));
        return await react(sock, message, ERROR);
    }
    
    try {
        console.log(chalk.cyan(`üë§ Kicking: ${targetJid}`));
        const result = await sock.groupParticipantsUpdate(chatId, [targetJid], 'remove');
        console.log(chalk.green('‚úÖ Kick result:'), result);
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error kicking member:'), error.message);
        await react(sock, message, ERROR);
    }
}

/**
 * Commande .promote - Promouvoir un membre admin
 * Usage: .promote @user ou reply
 */
export async function promote(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .promote command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    const targetJid = getTargetJid(message);
    
    if (!targetJid) {
        console.log(chalk.yellow('‚ö†Ô∏è No target for promote'));
        return await react(sock, message, ERROR);
    }
    
    try {
        console.log(chalk.cyan(`üë§ Promoting: ${targetJid}`));
        const result = await sock.groupParticipantsUpdate(chatId, [targetJid], 'promote');
        console.log(chalk.green('‚úÖ Promote result:'), result);
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error promoting member:'), error.message);
        await react(sock, message, ERROR);
    }
}

/**
 * Commande .demote - R√©trograder un admin
 * Usage: .demote @user ou reply
 */
export async function demote(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .demote command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    const targetJid = getTargetJid(message);
    
    if (!targetJid) {
        console.log(chalk.yellow('‚ö†Ô∏è No target for demote'));
        return await react(sock, message, ERROR);
    }
    
    try {
        console.log(chalk.cyan(`üë§ Demoting: ${targetJid}`));
        const result = await sock.groupParticipantsUpdate(chatId, [targetJid], 'demote');
        console.log(chalk.green('‚úÖ Demote result:'), result);
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error demoting member:'), error.message);
        await react(sock, message, ERROR);
    }
}

/**
 * Commande .demoteall - R√©trograder tous les admins
 * Usage: .demoteall
 */
export async function demoteall(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .demoteall command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    try {
        const groupMetadata = await sock.groupMetadata(chatId);
        const botNumber = sock.user.id.split(':')[0] + '@s.whatsapp.net';
        
        console.log(chalk.cyan(`ü§ñ Bot number: ${botNumber}`));
        
        // R√©cup√©rer tous les admins sauf le bot
        const admins = groupMetadata.participants
            .filter(p => p.admin && p.id !== botNumber)
            .map(p => p.id);
        
        console.log(chalk.cyan(`üë• Found ${admins.length} admins to demote`));
        
        if (admins.length === 0) {
            console.log(chalk.yellow('‚ö†Ô∏è No admins to demote'));
            return await react(sock, message, ERROR);
        }
        
        // R√©trograder tous les admins
        const result = await sock.groupParticipantsUpdate(chatId, admins, 'demote');
        console.log(chalk.green('‚úÖ Demote all result:'), result);
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error demoting all:'), error.message);
        await react(sock, message, ERROR);
    }
}

/**
 * Commande .gname - Changer le nom du groupe
 * Usage: .gname New Group Name
 */
export async function gname(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .gname command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    if (args.length === 0) {
        console.log(chalk.yellow('‚ö†Ô∏è No name provided'));
        return await react(sock, message, ERROR);
    }
    
    try {
        const newName = args.join(' ');
        console.log(chalk.cyan(`üìù New name: ${newName}`));
        
        await sock.groupUpdateSubject(chatId, newName);
        console.log(chalk.green('‚úÖ Name updated'));
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error updating group name:'), error.message);
        await react(sock, message, ERROR);
    }
}

/**
 * Commande .gdesc - Changer la description du groupe
 * Usage: .gdesc New description
 */
export async function gdesc(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .gdesc command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    if (args.length === 0) {
        console.log(chalk.yellow('‚ö†Ô∏è No description provided'));
        return await react(sock, message, ERROR);
    }
    
    try {
        const newDesc = args.join(' ');
        console.log(chalk.cyan(`üìù New description: ${newDesc}`));
        
        await sock.groupUpdateDescription(chatId, newDesc);
        console.log(chalk.green('‚úÖ Description updated'));
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error updating group description:'), error.message);
        await react(sock, message, ERROR);
    }
}

/**
 * Commande .glink - Obtenir le lien d'invitation du groupe
 * Usage: .glink
 */
export async function glink(sock, chatId, message, args) {
    console.log(chalk.magenta('üöÄ Executing .glink command'));
    
    if (!await checkPermissions(sock, chatId, message)) return;
    
    try {
        const code = await sock.groupInviteCode(chatId);
        const link = `https://chat.whatsapp.com/${code}`;
        
        console.log(chalk.green(`‚úÖ Group link: ${link}`));
        
        await sock.sendMessage(chatId, {
            text: `*GROUP LINK*\n\n${link}`
        }, { quoted: message });
        
        await react(sock, message, SUCCESS);
    } catch (error) {
        console.error(chalk.red('‚ùå Error getting group link:'), error.message);
        await react(sock, message, ERROR);
    }
}

// Export default
export default {
    add,
    kick,
    promote,
    demote,
    demoteall,
    gname,
    gdesc,
    glink
};