/**
 * ùó¶ùóòùó° Bot - APK Download (Style Bouton CTA)
 * Uses: stephtech-ui & David Cyril API
 */

import axios from 'axios';
import StephUI from 'stephtech-ui';
import response from '../lib/response.js';

export async function apkCommand(sock, chatId, message, args) {
    const ui = new StephUI(sock);
    const query = args.join(' ');

    if (!query) {
        return await sock.sendMessage(chatId, { 
            text: `üì± ${response.font('Nom de l\'application requis')}.\nEx: .apk WhatsApp` 
        }, { quoted: message });
    }

    try {
        await sock.sendMessage(chatId, { react: { text: 'üì≤', key: message.key } });

        // Appel API David Cyril
        const apiUrl = `https://apis.davidcyril.name.ng/download/apk?text=${encodeURIComponent(query)}&apikey=`;
        const { data } = await axios.get(apiUrl);

        // V√©rification bas√©e sur la nouvelle structure { status: true, apk: { ... } }
        if (!data.status || !data.apk) {
            return await sock.sendMessage(chatId, { text: '‚ùå Application introuvable.' }, { quoted: message });
        }

        const app = data.apk;

        // Pr√©paration du message texte
        let caption = `*APK DOWNLOADER*\n\n`;
        caption += `> *Nom :* ${app.name}\n`;
        caption += `> *ID :* ${app.package}\n`;
        caption += `> *M√†J :* ${app.lastUpdated}`;

        // Envoi du message avec Image + Bouton Lien (CTA)
        await ui.urlButtons(chatId, {
            text: caption,
            footer: "SEN DOWNLOADER",
            image: app.icon, // L'ic√¥ne de l'application
            buttons: [
                {
                    text: "üì• DOWNLOAD APK", // Texte du bouton
                    url: app.downloadLink    // Lien direct (CTA)
                }
            ],
            quoted: message
        });

    } catch (error) {
        console.error('APK Error:', error);
        await sock.sendMessage(chatId, { text: '‚ùå Erreur de recherche.' }, { quoted: message });
    }
}

export default { apkCommand };
