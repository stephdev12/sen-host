/**
 * ùó¶ùóòùó° Bot - Utility Commands
 * Copyright (c) 2024 ùôéùôèùôÄùôãùôÉùòøùôÄùôë
 */

import { downloadContentFromMessage } from '@whiskeysockets/baileys';

// --- GET PROFILE PICTURE ---
export async function getppCommand(sock, chatId, message, args) {
    try {
        let targetJid;
        const isGroup = chatId.endsWith('@g.us');
        const quoted = message.message?.extendedTextMessage?.contextInfo;

        if (quoted?.participant) {
            targetJid = quoted.participant; 
        } else if (quoted?.mentionedJid?.length > 0) {
            targetJid = quoted.mentionedJid[0]; 
        } else if (args.length > 0) {
            const num = args[0].replace(/[^0-9]/g, '');
            targetJid = num + '@s.whatsapp.net'; 
        } else {
            if (isGroup) {
                targetJid = chatId;
            } else {
                targetJid = message.key.participant || message.key.remoteJid;
            }
        }

        await sock.sendMessage(chatId, { 
            react: { text: 'üì∏', key: message.key }
        });

        try {
            const ppUrl = await sock.profilePictureUrl(targetJid, 'image');
            
            await sock.sendMessage(chatId, { 
                image: { url: ppUrl },
                caption: `> *PROFILE PICTURE*`
            }, { quoted: message });
            
        } catch (error) {
            await sock.sendMessage(chatId, { 
                text: '‚ùå No profile picture found or account is private' 
            }, { quoted: message });
        }

    } catch (error) {
        console.error('GetPP Error:', error);
        await sock.sendMessage(chatId, { 
            text: '‚ùå Error getting profile picture' 
        }, { quoted: message });
    }
}

// --- SAVE STATUS ---
export async function saveCommand(sock, chatId, message, args) {
    try {
        const quoted = message.message?.extendedTextMessage?.contextInfo?.quotedMessage;

        if (!quoted) {
            return sock.sendMessage(chatId, { 
                text: '‚ö†Ô∏è Reply to a status (image or video)' 
            }, { quoted: message });
        }

        await sock.sendMessage(chatId, { 
            react: { text: '‚¨áÔ∏è', key: message.key }
        });

        let buffer, type;

        if (quoted.imageMessage) {
            type = 'image';
            const stream = await downloadContentFromMessage(quoted.imageMessage, 'image');
            buffer = Buffer.from([]);
            for await (const chunk of stream) {
                buffer = Buffer.concat([buffer, chunk]);
            }
        } else if (quoted.videoMessage) {
            type = 'video';
            const stream = await downloadContentFromMessage(quoted.videoMessage, 'video');
            buffer = Buffer.from([]);
            for await (const chunk of stream) {
                buffer = Buffer.concat([buffer, chunk]);
            }
        } else {
            return sock.sendMessage(chatId, { 
                text: '‚ùå Unsupported media type' 
            }, { quoted: message });
        }

        if (type === 'image') {
            await sock.sendMessage(chatId, { 
                image: buffer, 
                caption: '‚úÖ *STATUS SAVED*' 
            }, { quoted: message });
        } else {
            await sock.sendMessage(chatId, { 
                video: buffer, 
                caption: '‚úÖ *STATUS SAVED*' 
            }, { quoted: message });
        }

    } catch (error) {
        console.error('Save Error:', error);
        await sock.sendMessage(chatId, { 
            text: '‚ùå Error saving status' 
        }, { quoted: message });
    }
}

export default { 
    getppCommand, 
    saveCommand 
};