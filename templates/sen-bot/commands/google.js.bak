/**
 * ğ—¦ğ—˜ğ—¡ Bot - Google AI Commands
 * Copyright (c) 2024 ğ™ğ™ğ™€ğ™‹ğ™ƒğ˜¿ğ™€ğ™‘
 * FREE TIER MODELS ONLY
 */

import { downloadContentFromMessage } from '@whiskeysockets/baileys';
import { isOwner } from '../lib/authHelper.js';
import configs from '../configs.js';
import googleApiManager from '../lib/googleApiManager.js';
import fs from 'fs';

/**
 * Commande .addgapi - Ajouter une clÃ© API Google
 */
export async function addgapiCommand(sock, chatId, message, args) {
    try {
        if (!await isOwner(sock, message, configs)) {
            return sock.sendMessage(chatId, {
                text: 'âŒ Owner only command'
            }, { quoted: message });
        }

        if (args.length === 0) {
            return sock.sendMessage(chatId, {
                text: 'ğŸ“ *ADD GOOGLE API KEY*\n\n' +
                      'Usage: .addgapi YOUR_API_KEY\n\n' +
                      'Get your free key:\n' +
                      '1. Go to https://aistudio.google.com\n' +
                      '2. Click "Get API key"\n' +
                      '3. Create new API key\n' +
                      '4. Copy and paste here'
            }, { quoted: message });
        }

        const apiKey = args[0];
        
        await sock.sendMessage(chatId, {
            react: { text: 'ğŸ”‘', key: message.key }
        });

        const isValid = await googleApiManager.testApiKey(apiKey);

        if (isValid) {
            googleApiManager.setApiKey(apiKey);
            
            await sock.sendMessage(chatId, {
                text: 'âœ… *GOOGLE API KEY ADDED*\n\n' +
                      'Free tier commands:\n' +
                      'â”ƒ .gemini - Chat AI (10 RPM)\n' +
                      'â”ƒ .vision - Analyze images\n' +
                      'â”ƒ .nanogen - Generate images (500/day)\n\n' +
                      'âš ï¸ Paid only:\n' +
                      'â”ƒ Imagen 4 - Not in free tier\n' +
                      'â”ƒ Veo 3.1 - Not in free tier'
            }, { quoted: message });
        } else {
            await sock.sendMessage(chatId, {
                text: 'âŒ Invalid API key\n\nCheck your key and try again.'
            }, { quoted: message });
        }

    } catch (error) {
        console.error('AddGAPI Error:', error);
        await sock.sendMessage(chatId, {
            text: 'âŒ Error adding API key'
        }, { quoted: message });
    }
}

/**
 * Commande .removegapi - Supprimer la clÃ© API
 */
export async function removegapiCommand(sock, chatId, message, args) {
    try {
        if (!await isOwner(sock, message, configs)) {
            return sock.sendMessage(chatId, {
                text: 'âŒ Owner only command'
            }, { quoted: message });
        }

        googleApiManager.removeApiKey();
        
        await sock.sendMessage(chatId, {
            text: 'âœ… Google API key removed'
        }, { quoted: message });

    } catch (error) {
        console.error('RemoveGAPI Error:', error);
        await sock.sendMessage(chatId, {
            text: 'âŒ Error removing API key'
        }, { quoted: message });
    }
}

/**
 * Commande .gemini - Chat avec Gemini 2.5 Flash (FREE)
 * Usage: .gemini your question
 */
export async function geminiCommand(sock, chatId, message, args) {
    try {
        const client = googleApiManager.getClient();
        if (!client) {
            return sock.sendMessage(chatId, {
                text: 'âš ï¸ No Google API key configured\n\n' +
                      'Use .addgapi YOUR_KEY to add one'
            }, { quoted: message });
        }

        const query = args.join(' ');
        if (!query) {
            return sock.sendMessage(chatId, {
                text: 'ğŸ“ Usage: .gemini <question>\n\n' +
                      'Example: .gemini Explain quantum computing'
            }, { quoted: message });
        }

        await sock.sendMessage(chatId, {
            react: { text: 'ğŸ¤–', key: message.key }
        });

        // Utiliser gemini-2.5-flash (FREE TIER)
        const response = await client.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: query
        });

        const text = response.text;

        await sock.sendMessage(chatId, {
            text: `*GEMINI AI*\n\n${text}`
        }, { quoted: message });

    } catch (error) {
        console.error('Gemini Error:', error);
        
        let errorMsg = 'âŒ Error generating response';
        
        if (error.message?.includes('quota') || error.message?.includes('429')) {
            errorMsg = 'âŒ Quota exceeded\n\nFree tier: 10 RPM, 250 RPD\nWait 1 minute or upgrade.';
        } else if (error.message?.includes('invalid')) {
            errorMsg = 'âŒ Invalid API key. Use .addgapi to update.';
        }
        
        await sock.sendMessage(chatId, {
            text: errorMsg
        }, { quoted: message });
    }
}

/**
 * Commande .vision - Analyser une image avec Gemini Vision (FREE)
 * Usage: .vision <question> (reply to image)
 */
export async function visionCommand(sock, chatId, message, args) {
    try {
        const client = googleApiManager.getClient();
        if (!client) {
            return sock.sendMessage(chatId, {
                text: 'âš ï¸ No Google API key configured\n\n' +
                      'Use .addgapi YOUR_KEY to add one'
            }, { quoted: message });
        }

        const quoted = message.message?.extendedTextMessage?.contextInfo?.quotedMessage;
        const imageMsg = quoted?.imageMessage || message.message?.imageMessage;

        if (!imageMsg) {
            return sock.sendMessage(chatId, {
                text: 'ğŸ“ Usage: Reply to an image with .vision <question>\n\n' +
                      'Example: .vision What is in this image?'
            }, { quoted: message });
        }

        const query = args.join(' ') || 'Describe this image in detail';

        await sock.sendMessage(chatId, {
            react: { text: 'ğŸ‘ï¸', key: message.key }
        });

        // TÃ©lÃ©charger l'image
        const stream = await downloadContentFromMessage(imageMsg, 'image');
        let buffer = Buffer.from([]);
        for await (const chunk of stream) {
            buffer = Buffer.concat([buffer, chunk]);
        }

        const base64Image = buffer.toString('base64');

        // Utiliser gemini-2.5-flash pour vision (FREE)
        const response = await client.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: [
                {
                    role: 'user',
                    parts: [
                        { text: query },
                        {
                            inlineData: {
                                mimeType: 'image/jpeg',
                                data: base64Image
                            }
                        }
                    ]
                }
            ]
        });

        const text = response.text;

        await sock.sendMessage(chatId, {
            text: `*GEMINI VISION*\n\n${text}`
        }, { quoted: message });

    } catch (error) {
        console.error('Vision Error:', error);
        
        let errorMsg = 'âŒ Error analyzing image';
        
        if (error.message?.includes('quota') || error.message?.includes('429')) {
            errorMsg = 'âŒ Quota exceeded. Wait and try again.';
        }
        
        await sock.sendMessage(chatId, {
            text: errorMsg
        }, { quoted: message });
    }
}

/**
 * Commande .nanogen - GÃ©nÃ©rer image avec Nano Banana (FREE)
 * Usage: .nanogen <prompt>
 * FREE TIER: 500 images/day, 15 RPM
 */
export async function nanogenCommand(sock, chatId, message, args) {
    try {
        const client = googleApiManager.getClient();
        if (!client) {
            return sock.sendMessage(chatId, {
                text: 'âš ï¸ No Google API key configured\n\n' +
                      'Use .addgapi YOUR_KEY to add one'
            }, { quoted: message });
        }

        const prompt = args.join(' ');
        if (!prompt) {
            return sock.sendMessage(chatId, {
                text: 'ğŸ“ Usage: .nanogen <description>\n\n' +
                      'Example: .nanogen a futuristic city at sunset\n\n' +
                      'ğŸ†“ Free: 500 images/day, 15 RPM'
            }, { quoted: message });
        }

        await sock.sendMessage(chatId, {
            react: { text: 'ğŸŒ', key: message.key }
        });

        await sock.sendMessage(chatId, {
            text: 'â³ Generating image...'
        }, { quoted: message });

        // Utiliser gemini-2.5-flash-image-preview (FREE TIER)
        const response = await client.models.generateContent({
            model: 'gemini-2.5-flash-image-preview',
            contents: prompt
        });

        // Extraire l'image
        for (const part of response.candidates[0].content.parts) {
            if (part.inlineData) {
                const imageBuffer = Buffer.from(part.inlineData.data, 'base64');
                
                await sock.sendMessage(chatId, {
                    image: imageBuffer,
                    caption: `*NANO BANANA ğŸŒ*\n\nPrompt: ${prompt}\n\nâœ¨ 1024x1024 resolution`
                }, { quoted: message });
                return;
            }
        }

        await sock.sendMessage(chatId, {
            text: 'âŒ No image generated'
        }, { quoted: message });

    } catch (error) {
        console.error('Nano Banana Error:', error);
        
        let errorMsg = 'âŒ Error generating image';
        
        if (error.message?.includes('quota') || error.message?.includes('429')) {
            errorMsg = 'âŒ Quota exceeded\n\nğŸ†“ Free: 500/day, 15 RPM\nWait or upgrade to paid.';
        } else if (error.message?.includes('RESOURCE_EXHAUSTED')) {
            errorMsg = 'â³ Rate limit (15 RPM). Wait 1 minute.';
        }
        
        await sock.sendMessage(chatId, {
            text: errorMsg
        }, { quoted: message });
    }
}

/**
 * Commande .gstatus - Voir le statut API
 */
export async function gstatusCommand(sock, chatId, message, args) {
    try {
        const apiKey = googleApiManager.getApiKey();
        const hasKey = !!apiKey;

        let text = `â”â”â”ã€” GOOGLE AI STATUS ã€•â”â”â”“\n\n`;
        text += `API Key: ${hasKey ? 'âœ… Configured' : 'âŒ Not set'}\n`;
        text += `SDK: @google/genai\n`;
        text += `Tier: Free\n\n`;
        
        if (hasKey) {
            text += `ğŸ†“ FREE TIER MODELS:\n\n`;
            text += `âœ… Gemini 2.5 Flash\n`;
            text += `â”ƒ .gemini - Chat AI\n`;
            text += `â”ƒ Limits: 10 RPM, 250 RPD\n\n`;
            
            text += `âœ… Gemini Vision\n`;
            text += `â”ƒ .vision - Image analysis\n`;
            text += `â”ƒ Same as chat limits\n\n`;
            
            text += `âœ… Nano Banana (Flash Image)\n`;
            text += `â”ƒ .nanogen - Generate images\n`;
            text += `â”ƒ Limits: 500/day, 15 RPM\n\n`;
            
            text += `âŒ PAID ONLY:\n`;
            text += `â”ƒ Imagen 4 - Requires billing\n`;
            text += `â”ƒ Veo 3.1 - Requires billing\n`;
        } else {
            text += `Use .addgapi YOUR_KEY\n`;
        }
        
        text += `\nâ”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›`;

        await sock.sendMessage(chatId, { text }, { quoted: message });

    } catch (error) {
        console.error('GStatus Error:', error);
        await sock.sendMessage(chatId, {
            text: 'âŒ Error checking status'
        }, { quoted: message });
    }
}

export default {
    addgapiCommand,
    removegapiCommand,
    geminiCommand,
    visionCommand,
    nanogenCommand,
    gstatusCommand
};