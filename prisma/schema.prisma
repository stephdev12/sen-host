// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  password         String
  username         String
  coins            Int      @default(0)
  role             String   @default("user") // "user" or "admin"
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  bots             Bot[]
  lastDailyCoinAt  DateTime?
  referralCode     String?  @unique
  referredById     String?
  emailVerified    DateTime?
  verificationToken String?
  referredBy       User?    @relation("Referrals", fields: [referredById], references: [id])
  referrals        User[]   @relation("Referrals")

  // Ad System
  lastAdWatchAt    DateTime?
  dailyAdCount     Int      @default(0)
  lastDailyAdReset DateTime? @default(now())

  // Premium System
  isPremium        Boolean  @default(false)
  premiumExpiresAt DateTime?

  // Notifications
  fcmToken         String?

  // Community
  messages         Message[]
}

model Message {
  id        String   @id @default(cuid())
  content   String?
  image     String?  // Path to stored image
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Bot {
  id          String   @id @default(cuid())
  name        String
  phoneNumber String?
  status      String   @default("stopped") // stopped, running, pairing
  pairingCode String?
  folderPath  String?
  processId   Int?     // PID of the running process
  
  // Type definition
  type        String   @default("TEMPLATE") // "TEMPLATE" or "CUSTOM"
  
  template    String   @default("sen-bot") // Le dossier dans /templates

  // For Custom Bots
  repoUrl      String?  // If source is Git
  zipFilePath  String?  // If source is Uploaded ZIP
  startCommand String?  @default("npm start")
  envVars      String?  // Stored as JSON string
  envFileName  String?  @default(".env")

  nodeId      String?  // ID du serveur (null = serveur local)
  node        Node?    @relation(fields: [nodeId], references: [id])
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expiresAt   DateTime?
  lastDeductionAt DateTime? // Date de la dernière déduction de coins
}

model Node {
  id        String   @id @default(cuid())
  name      String   // Ex: "VPS France 1"
  url       String   // Ex: "http://192.168.1.50:8080"
  apiKey    String   // Pour sécuriser les appels API vers ce node
  enabled   Boolean  @default(true)
  bots      Bot[]
  createdAt DateTime @default(now())
}

model GlobalSettings {
  id              Int     @id @default(1)
  maxTotalBots    Int     @default(100)
  minCoinsToCreate Int    @default(10)
  maintenanceMode Boolean @default(false)
}

model Template {
  id          String   @id @default(cuid())
  name        String
  description String?
  folderName  String   @unique
  sourceType  String   // 'GIT' or 'ZIP'
  repoUrl     String?
  sessionIdUrl String? // URL to get Session ID
  envVars     String?  // JSON string of detected variables
  startCommand String? @default("node index.js")
  envFileName String?  @default(".env")
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}